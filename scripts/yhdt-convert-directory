#!/bin/bash

# Ищем файлы с расширением $extension в каталоге $DIR и конвертируем в TIFF
 
SELF="`basename $0`"
SELF_PATH="`dirname $0`"

. "$SELF_PATH/functions.sh"

DIR="$1"
EXTENSION="$2"

BLEND_BRACKETED_BIN="$SELF_PATH/yhdt-blend-bracketed"

EXIFTOOL=`which exiftool`
UFRAW_BATCH=`which ufraw-batch`

IFS=$'\n'

if [ -z "$UFRAW_BATCH" ]; then
    echo "Для работы необходим UFRaw"
    exit
fi

if [ -z "$EXIFTOOL" ]; then
    echo "Для работы необходим exiftool"
    exit
fi

if [ -z "$DIR" ]; then
    echo "Укажите каталог с файлами"
    exit
fi

if [ ! -d "$DIR" ]; then
    echo "$DIR не является директорией"
    exit
fi

if [ -z "$EXTENSION" ]; then
    echo "Укажите расширение файлов"
    exit
fi

DIR=$(cd "$DIR" && pwd) #transform to absolute path

JPG_DIR="$DIR/jpg"
TIF_DIR="$DIR/_tif"

cr_count=`find "$DIR" -maxdepth 1 -type f -iname "*.$EXTENSION" -print | wc -l`

convertDirectory() {
    local space_status
    local image
    local ufraw_config="$DIR/img.ufraw"
    declare -a images
    
    for image in `find "$DIR" -maxdepth 1 -type f -iname "*.$EXTENSION" -print | sort`; do
        images=( "${images[@]}" "$image" )
    done

    echo "Конвертирую каталог '$DIR'..."
    check_space_for_tifs ${#images[@]} "$DIR"
    if [ ! $SPACE_STATUS -eq 0 ]; then
        echo "Недостаточно места на диске. Выходим"
        return $E_NO_SPACE
    fi
  
    if [ ! -d "$JPG_DIR" ]; then
        mkdir "$JPG_DIR"
    fi
    if [ ! -d "$TIF_DIR" ]; then
        mkdir "$TIF_DIR"
    fi

    find "$DIR" -maxdepth 1 -type f -iname "*.jpg" -exec mv {} "$JPG_DIR" \;
    
    $UFRAW_BATCH --create-id=only --out-type=tif --out-depth=16 --wb=auto --silent --overwrite --output="$DIR/img" "${images[0]}"
    
    local temp=`grep Temperature "$ufraw_config" | grep -P '[\d.]+' -o`
    local green=`grep Green "$ufraw_config" | grep -P '[\d.]+' -o`
    rm "$ufraw_config"
    
    $UFRAW_BATCH --temperature=$temp --green=$green --out-path="$TIF_DIR" --out-type=tif --out-depth=16 --create-id=no \
        --zip --silent --overwrite "$DIR"/*.$EXTENSION
}

if [ -f "$DIR/._converted" ]; then
    echo "Файлы в каталоге '$DIR' уже сконвертированы. Пропускаем."
else
    # Пропускаем каталоги, в которых нет CR2
    if [ $cr_count -gt 0 ]; then
        convertDirectory
        if [ $? -eq 0 ]; then
            touch "$DIR/._converted"
        fi
    fi
fi

# И сразу сведем брекетинг уже из TIFF`ов
"$BLEND_BRACKETED_BIN" "$TIF_DIR" "tif"
